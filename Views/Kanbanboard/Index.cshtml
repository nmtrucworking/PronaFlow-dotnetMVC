@model PronaFlow_MVC.Models.ViewModels.KanbanBoardViewModel
@{
    ViewBag.Title = "Kanban Board | PronaFlow";
}
@{
    string GetUiStatus(string dbStatus)
    {
        var statusMapping = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            { "temp", "temp"},
            { "notstarted", "not-started"},
            { "inprogress", "in-progress"},
            { "inreview", "in-review"},
            { "done", "done"},
        };
        return statusMapping.TryGetValue(dbStatus, out var uiStatus) ? uiStatus : "unknown-status";
    }
}
@{
    var columns = new[]
    {
        new { Title = "Temp",         UiStatus = "temp" },
        new { Title = "Not Started",  UiStatus = "not-started" },
        new { Title = "In Progress",  UiStatus = "in-progress" },
        new { Title = "In Review",    UiStatus = "in-review" },
        new { Title = "Done",         UiStatus = "done" },
    };
    var byStatus = Model.Projects.GroupBy(p => GetUiStatus(p.Status))
                                 .ToDictionary(g => g.Key, g => g.AsEnumerable());
}

<main id="main" class="main kanban-board">
    <div class="kanban-board__header">
        <div class="workspace__title">
            <span id="workspaceName">@Model.WorkspaceName</span>
        </div>
        <span id="workspaceDescription" class="workspace__description">@Model.WorkspaceDescription</span>
    </div>

    <div class="divider"></div>

    <div class="frames frames--grid-2col">
        <!--  CALENDAR FRAME (PRONAFLOW AGENDA) - START  -->
        <div class="frame frame--kanban">
            <h3 class="frame__title">My Agenda</h3>
            <div class="frame__content hide-scrollbar">
                <div class="agenda">
                    <!-- ========== Agenda Group: August 30 ========== -->
                    <div class="agenda__group">
                        <div class="agenda__date agenda__date--today">
                            Today
                            <span>August 30</span>
                        </div>
                        <div class="agenda__events">
                            <!-- EVENT: PROJECT -->
                            <div class="event-item event-item--project">
                                <div class="event-item__icon-wrapper">
                                    <i data-lucide="briefcase" class="event-item__icon"></i>
                                </div>
                                <div class="event-item__content">
                                    <div class="event-item__header">
                                        <span class="event-item__title">Website Redesign</span>
                                    </div>
                                    <div class="event-item__meta">
                                        <div class="event-item__meta-group">
                                            <i data-lucide="check-circle-2"></i>
                                            <span>5/12 Tasks</span>
                                        </div>
                                        <div class="event-item__meta-group">
                                            <i data-lucide="flag"></i>
                                            <span>Deadline: Sep 15</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- EVENT: TASK (HIGH PRIORITY) -->
                            <div class="event-item event-item--task">
                                <div class="event-item__icon-wrapper">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" />
                                        <span class="custom-checkbox__checkmark"></span>
                                    </label>
                                </div>
                                <div class="event-item__content">
                                    <div class="event-item__header">
                                        <span class="event-item__title">Finalize Homepage Mockup</span>
                                    </div>
                                    <div class="event-item__meta">
                                        <div class="event-item__meta-group">
                                            <i data-lucide="folder-open"></i>
                                            <span>In: Website Redesign</span>
                                        </div>
                                        <div class="event-item__meta-group event-item__meta-group--priority-high">
                                            <i data-lucide="star"></i>
                                            <span>High Priority</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== Agenda Group: August 31 ========== -->
                    <div class="agenda__group">
                        <div class="agenda__date">
                            Sunday
                            <span>August 31</span>
                        </div>
                        <div class="agenda__events">
                            <!-- EVENT: TASK (COMPLETED) -->
                            <div class="event-item event-item--task event-item--completed">
                                <div class="event-item__icon-wrapper">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" checked />
                                        <span class="custom-checkbox__checkmark"></span>
                                    </label>
                                </div>
                                <div class="event-item__content">
                                    <div class="event-item__header">
                                        <span class="event-item__title">Review competitor analysis</span>
                                    </div>
                                    <div class="event-item__meta">
                                        <div class="event-item__meta-group">
                                            <i data-lucide="folder-open"></i>
                                            <span>In: Marketing Q4</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- EVENT: TASK (MEDIUM PRIORITY) -->
                            <div class="event-item event-item--task">
                                <div class="event-item__icon-wrapper">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" />
                                        <span class="custom-checkbox__checkmark"></span>
                                    </label>
                                </div>
                                <div class="event-item__content">
                                    <div class="event-item__header">
                                        <span class="event-item__title">Prepare slides for client meeting</span>
                                    </div>
                                    <div class="event-item__meta">
                                        <div class="event-item__meta-group">
                                            <i data-lucide="folder-open"></i>
                                            <span>In: Project Alpha</span>
                                        </div>
                                        <div class="event-item__meta-group event-item__meta-group--priority-medium">
                                            <i data-lucide="star"></i>
                                            <span>Medium Priority</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ========== Agenda Group: September 01 ========== -->
                    <div class="agenda__group">
                        <div class="agenda__date">
                            Monday
                            <span>September 01</span>
                        </div>
                        <div class="agenda__events">
                            <!-- EVENT: PROJECT -->
                            <div class="event-item event-item--project">
                                <div class="event-item__icon-wrapper">
                                    <i data-lucide="briefcase" class="event-item__icon"></i>
                                </div>
                                <div class="event-item__content">
                                    <div class="event-item__header">
                                        <span class="event-item__title">API Integration Testing</span>
                                    </div>
                                    <div class="event-item__meta">
                                        <div class="event-item__meta-group">
                                            <i data-lucide="check-circle-2"></i>
                                            <span>0/8 Tasks</span>
                                        </div>
                                        <div class="event-item__meta-group">
                                            <i data-lucide="flag"></i>
                                            <span>Deadline: Sep 20</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="frame frame--kanban">
            <h3 class="frame__title">My Tasks</h3>
            <div class="frame__content hide-scrollbar">
                <div class="task-list">
                    <!-- sample task-card -->
                </div>
            </div>
        </div>
    </div>
    .

    <div class="divider"></div>
    <input type="hidden" id="currentWorkspaceId" value="@Model.CurrentWorkspaceId" />
    <div id="kanban-view" class="kanban-view">
        @foreach (var col in columns)
        {
            var projects = byStatus.TryGetValue(col.UiStatus, out var list)
                ? list
                : Enumerable.Empty<PronaFlow_MVC.Models.ViewModels.KanbanProjectCardViewModel>();

            @Html.Partial("_KanbanColumn", new { Title = col.Title, UiStatus = col.UiStatus, Projects = projects, WorkspaceId = Model.CurrentWorkspaceId })
        }
    </div>

</main>

@section scripts {
    <script src="~/wwwroot/js/KanbanPageRefactored.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.lucide) { lucide.createIcons(); }
            initializeAddProjectButtons();
            initializeProjectCardClicks();
            initKanbanDragDrop();
        });
    </script>
}

@if (ViewBag.OpenProjectId != null)
{
    @Html.Action("DetailsPartial", "Project", new { id = (int)ViewBag.OpenProjectId })
}
