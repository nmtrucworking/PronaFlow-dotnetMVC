@model PronaFlow_MVC.Models.ViewModels.ProjectDetailsViewModel
@{
    Layout = null;
    var defaultAvatarUrl = "../assets/images/avt-notion_1.png";
}

<div class="modal-container modal-container--centered modal-component" id="projectDetailModal">

    <a href="@Url.Action("Index", "Kanbanboard", new { workspaceId = ViewBag.CurrentWorkspaceId })"
       class="modal-overlay-backdrop"
    </a>

    <div class="modal__content no-scrollbar">

        <!-- =============================================================== -->
        <!--                  LOADING STATE                                  -->
        <!-- =============================================================== -->
        <div class="skeleton-loader">
            <div class="skeleton-line skeleton-header"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line skeleton-short"></div>
            <div class="skeleton-line skeleton-short"></div>
            <div class="skeleton-line skeleton-header"></div>
            <div class="skeleton-line"></div>
        </div>

        <!-- =============================================================== -->
        <!--                     MODAL CONTENT                               -->
        <!-- =============================================================== -->
        <div class="modal__body-wrapper">
            <!-- Project cover image (hidden by default) -->
            <div class="project__cover"></div>

            <!-- ========== HEADER ========== -->
            <div class="modal__header">
                <div class="inner__header">
                    <div class="modal-header__top">
                        @using (Html.BeginForm("UpdateNameDescription", "Project", FormMethod.Post, new { @class = "inline-edit-form" }))
                        {
                            @Html.AntiForgeryToken()
                            @Html.Hidden("id", Model.Id)
                            <label class="custom-checkbox">
                                <input type="checkbox" name="project-status-checkbox" id="project-status-checkbox" @(Model.Status == "done" ? "checked" : "") disabled>
                                <span class="custom-checkbox__checkmark round"></span>
                            </label>
                            <div id="project-title-container" class="project-detail__title inline-editable" data-placeholder="Project Title">
                                <div class="inline-editable__display" id="project-title-display">@Model.Name</div>
                                <div class="inline-editable__edit">
                                    <input type="text" class="inline-edit-input" name="name" value="@Model.Name" id="project-title-input" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn--primary btn--small" title="Save name">Save</button>
                        }
                    </div>
                    <div class="modal-header__bot">
                        <span>Project status: </span>
                        <!-- Custom Select Wrapper -->
                        <div class="custom-select-wrapper">
                            <select id="prj-mdl-status" name="status" class="project-status-selecter">
                                <option value="temp" @(Model.Status == "temp" ? "selected" : "")>On Hold</option>
                                <option value="not-started" @(Model.Status == "not-started" ? "selected" : "")>Not Started</option>
                                <option value="in-progress" @(Model.Status == "in-progress" ? "selected" : "")>In Progress</option>
                                <option value="in-review" @(Model.Status == "in-review" ? "selected" : "")>In Review</option>
                                <option value="done" @(Model.Status == "done" ? "selected" : "")>Completed</option>
                            </select>
                            <i data-lucide="chevron-down" class="custom-select-arrow"></i>
                        </div>
                    </div>
                </div>

                <!-- Main close button -->
                <a class="btn-exit" id="closeProjectDetailModal" href="@Url.Action("Index", "Kanbanboard", new { workspaceId = ViewBag.CurrentWorkspaceId })">
                    <i class="nav-icon icon-lg" data-lucide="x"></i>
                </a>

            </div>

            <!-- ========== BODY ========== -->
            <div class="modal__body">
                <!-- ===== MAIN CONTENT COLUMN ===== -->
                <div class="modal__main">
                    <!-- Attributes section -->
                    <div class="modal-project__attributes">
                        <!-- Attribute: Members -->
                        <div class="attribute-box">
                            <div class="attribute__name">Members</div>
                            <div class="attribute__content">
                                <ul class="list_attributes">
                                    @if (Model.Members != null && Model.Members.Any())
                                    {
                                        foreach (var member in Model.Members)
                                        {
                                            var avatarUrl = string.IsNullOrEmpty(member.AvatarUrl)
                                                ? defaultAvatarUrl
                                                : member.AvatarUrl;

                                            <img src="@avatarUrl" alt="User @member.UserId"
                                                 title="User ID: @member.UserId"
                                                 class="project-member__avt"
                                                 style="width:24px;height:24px;border-radius:50%; object-fit:cover;">
                                        }
                                    }
                                    <button class="add-member btn-hover" id="addMemberBtn" popovertarget="addMemberPopover"
                                            popovertargetaction="toggle">
                                        <i data-lucide="user-plus"></i>
                                    </button>
                                </ul>

                                @Html.Partial("~/Views/Project/_AddMemberPopover.cshtml", Model)
                            </div>
                        </div>
                        <!-- Attribute: Tags -->
                        <div class="attribute-box">
                            <div class="attribute__name">Tags</div>
                            <div class="attribute__content">
                                <ul class="list_attributes--tags">
                                    @if (Model.Tags != null && Model.Tags.Any())
                                    {
                                        foreach (var tag in Model.Tags)
                                        {
                                            <div class="tag-card" style="background-color: @tag.ColorHex;">
                                                <span class="tag__name">@tag.Name</span>
                                                @using (Html.BeginForm("RemoveTag", "Project", FormMethod.Post, new { style = "display:inline; margin-left:4px;" }))
                                                {
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@Model.Id" />
                                                    <input type="hidden" name="tagId" value="@tag.Id" />
                                                    <button type="submit" style="background:none;border:none;cursor:pointer;color:white;">&times;</button>
                                                }
                                            </div>
                                        }
                                    }
                                </ul>
                                <button class="add-member btn-hover" id="addTagBtn" popovertarget="manageTagsPopover"
                                        popovertargetaction="toggle">
                                    <i data-lucide="tags"></i>
                                </button>

                                @Html.Partial("~/Views/Project/_ManagProjectTagsPopover.cshtml", Model)
                            </div>

                        </div>
                        <!-- Attribute: Deadline -->
                        <div class="attribute-box">
                            <div class="attribute__name">Deadline</div>
                            <div class="attribute__content">
                                <div class="deadline" id="project_deadline">
                                    <span class="start-date due-date">@((Model.StartDate?.ToShortDateString()) ?? "-")</span>
                                    <span>-</span>
                                    <span class="end-date due-date">@((Model.EndDate?.ToShortDateString()) ?? "-")</span>
                                </div>
                                <button class="btn-icon-small" popovertarget="project-deadline-popover"><i data-lucide="calendar"></i></button>
                            </div>
                        </div>
                        <!-- Popover: Set Project Deadline -->
                        <div id="project-deadline-popover" popover class="popover project-attribute-popover">
                            <div class="popover__header">
                                <span class="popover__title">Set Deadline</span>
                                <button class="btn-exit" popovertarget="project-deadline-popover" popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <div class="form-box">
                                    <label for="project-start-date" class="form-label">Start date</label>
                                    <input type="date" id="project-start-date" class="form-input" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" />
                                </div>
                                <div class="form-box">
                                    <label for="project-end-date" class="form-label">End date</label>
                                    <input type="date" id="project-end-date" class="form-input" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" />
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn--primary btn--small">Save</button>
                                    <button type="button" class="btn btn--secondary btn--small" popovertarget="project-deadline-popover" popovertargetaction="hide">Cancel</button>
                                </div>
                            </div>
                        </div>
                        <!-- Attribute: Countdown -->
                        <div class="attribute-box">
                            <div class="attribute__name">Countdown</div>
                            <div class="attribute__content">
                                <div class="countdown-tag" style="margin-left: 8px;">
                                    <i data-lucide="hourglass" class="icon--minium"></i>
                                    <span id="projectCountdown">2d</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Description -->
                    <div class="project-modal-section">
                        <div class="project-modal-section__title">
                            <div class="left-col"><i data-lucide="text"></i></div>
                            <div class="project-modal-section__inner-title">Description</div>
                        </div>
                        @using (Html.BeginForm("UpdateNameDescription", "Project", FormMethod.Post))
                        {
                            @Html.AntiForgeryToken()
                            @Html.Hidden("id", Model.Id)
                            @Html.Hidden("name", Model.Name) <textarea class="project__description" name="description" rows="4" style="width:100%;">@Model.Description</textarea>
                            <button type="submit" class="btn btn--secondary btn--small">Update Desc</button>
                        }
                    </div>

                    <div id="project-tasklists">
                        <!-- Section: Task list (EXAMPLE 1: EMPTY LIST) -->
                        <div class="project-modal-section">
                            <div class="project-modal-section__title task-list-title">
                                <div class="left-col"><i data-lucide="square-check-big"></i></div>
                                <div class="inline-editable" data-placeholder="Phase Title">
                                    <div class="inline-editable__display">Phase 1: Research</div>
                                    <div class="inline-editable__edit">
                                        <input type="text" class="inline-edit-input" value="Phase 1: Research">
                                    </div>
                                </div>
                                <button class="btn-delete-section btn-hover"><i data-lucide="trash-2"></i></button>
                            </div>
                            <!-- Empty state -->

                            @if (Model.Tasks != null && Model.Tasks.Any())
                            {
                                // Group task theo Task List Name
                                var groupedTasks = Model.Tasks.GroupBy(t => t.TaskListName);
                                foreach (var group in groupedTasks)
                                {
                                    <div class="project-modal-section">
                                        <div class="project-modal-section__title task-list-title">
                                            <div class="left-col"><i data-lucide="square-check-big"></i> @group.Key</div>
                                        </div>
                                        <div class="task-list">
                                            @foreach (var task in group)
                                            {
                                                @Html.Partial("~/Views/Project/_ProjectTaskCard.cshtml", task)
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="task-list task-list--empty">
                                    <div class="empty-state-compact">
                                        <i data-lucide="check-square"></i>
                                        <span>No tasks yet.</span>
                                        <span>Add a new task below!</span>
                                    </div>
                                </div>
                            }

                            <div class="add-new-task-input" style="margin-left: 35px; margin-top: 10px;">
                                <input type="text" class="add-new-task" placeholder="+ Add new task">
                            </div>
                        </div>
                    </div>

                    <!-- Section: Recent Activity -->
                    <div class="project-modal-section">
                        <div class="project-modal-section__title">
                            <div class="left-col"><i data-lucide="activity"></i></div>
                            <div class="project-modal-section__inner-title">Activity</div>
                        </div>
                        <div class="list-col" style="margin-left: 20px;">
                            <div class="attribute-box__item">
                                <img src="../assets/images/avt-notion_1.png" alt="" class="project-member__avt">
                                <div class="activity">
                                    <span id="user" style="font-weight: 600;">Nguyễn Minh Trúc</span>
                                    <span id="activity-content">
                                        moved this card from <b>Not Started</b> to <b>
                                            In
                                            Progress
                                        </b>
                                    </span>
                                    <div style="font-size: 12px; color: var(--color-text-secondary);">
                                        2 hours ago
                                    </div>
                                </div>
                            </div>
                            <div class="attribute-box__item">
                                <img src="../assets/images/avt-notion_2.png" alt="" class="project-member__avt">
                                <div class="activity">
                                    <span id="user" style="font-weight: 600;">Trần Văn An</span>
                                    <span id="activity-content">added task "Design wireframe for Dashboard"</span>
                                    <div style="font-size: 12px; color: var(--color-text-secondary);">
                                        Yesterday, at
                                        3:30 PM
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Added: Comment input for Activity -->
                        <div class="activity-comment-box"
                             style="margin-left: 20px; margin-top: 10px; display: flex; gap: 8px; align-items: flex-start;">
                            <textarea class="form-input form-input--small activity-comment-input"
                                      placeholder="Viết bình luận..."></textarea>
                            <button class="btn btn--primary btn--small post-activity-comment-btn">Đăng</button>
                        </div>
                    </div>
                </div>

                <!-- ===== SIDEBAR ACTIONS ===== -->
                <div class="modal__sidebar">
                    <div class="modal-sidebar__section">
                        <div class="modal-sidebar__title">Add to card</div>
                        <div class="list-col">
                            <!-- Nút Attachment -->
                            <button id="btn-attachment" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="attachment-popover">
                                <i data-lucide="paperclip"></i><span>Attachment</span>
                            </button>

                            <!-- Nút Cover Image -->
                            <button id="btn-cover-image" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="cover-image-popover">
                                <i data-lucide="image"></i><span>Cover Image</span>
                            </button>
                        </div>

                        <!-- === POP-OVER CONTENT for "Add to card" === -->
                        <!-- Popover cho Attachment -->
                        <div id="attachment-popover" popover class="popover sidebar-popover">
                            <div class="popover__header">
                                <h4 class="popover__title">Attach file</h4>
                                <button class="btn-exit" popovertarget="attachment-popover"
                                        popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: 10px;">
                                    Upload a file from your computer.
                                </p>
                                <input type="file" class="form-input">
                                <button class="btn btn--primary" style="width: 100%; margin-top: 10px;">Upload</button>
                            </div>
                        </div>

                        <!-- Popover cho Cover Image -->
                        <div id="cover-image-popover" popover class="popover sidebar-popover">
                            <div class="popover__header">
                                <h4 class="popover__title">Cover Image</h4>
                                <button class="btn-exit" popovertarget="cover-image-popover"
                                        popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: 10px;">
                                    Choose an image for the card cover.
                                </p>
                                <button class="btn" style="width: 100%;">Upload Image</button>
                                <button class="btn" style="width: 100%; margin-top: 5px;">Choose from Unsplash</button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-sidebar__section">
                        <div class="modal-sidebar__title">Actions</div>
                        <div class="list-col">
                            <!-- Nút Move -->
                            <button id="btn-move" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="move-popover">
                                <i data-lucide="move"></i><span>Move</span>
                            </button>

                            <!-- Nút Duplicate -->
                            <button id="btn-duplicate" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="duplicate-popover">
                                <i data-lucide="copy"></i><span>Duplicate</span>
                            </button>

                            <!-- Added: Add TaskList button -->
                            <button id="btn-add-tasklist" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="add-tasklist-popover">
                                <i data-lucide="list-plus"></i><span>Add TaskList</span>
                            </button>

                            <!-- Nút Archive -->
                            <button id="btn-archive" class="sidebar-action-btn btn-hover" type="button"
                                    popovertarget="archive-popover">
                                <i data-lucide="archive"></i><span>Archive</span>
                            </button>
                        </div>

                        <!-- === POP-OVER CONTENT for "Actions" === -->
                        <!-- Popover cho Move -->
                        <div id="move-popover" popover class="popover sidebar-popover">
                            <div class="popover__header">
                                <h4 class="popover__title">Move card</h4>
                                <button class="btn-exit" popovertarget="move-popover" popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <div class="form-box">
                                    <label for="move-target-list" class="form-label">Select destination</label>
                                    <select id="move-target-list" class="form-input">
                                        <option value="list1">To-Do</option>
                                        <option value="list2">In Progress</option>
                                        <option value="list3">Done</option>
                                    </select>
                                </div>
                                <button class="btn btn--primary" style="width: 100%; margin-top: 10px;">Move</button>
                            </div>
                        </div>

                        <!-- Popover cho Duplicate -->
                        <div id="duplicate-popover" popover class="popover sidebar-popover">
                            <div class="popover__header">
                                <h4 class="popover__title">Duplicate card</h4>
                                <button class="btn-exit" popovertarget="duplicate-popover" popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <p>This will create an exact copy of this card.</p>
                            </div>
                            <div class="popover__footer">
                                <button class="btn btn--tertiary" popovertarget="duplicate-popover"
                                        popovertargetaction="hide">
                                    Cancel
                                </button>
                                <button class="btn btn--primary">Confirm</button>
                            </div>
                        </div>

                        <!-- Added: Popover for Add TaskList -->
                        <div id="add-tasklist-popover" popover class="popover sidebar-popover">
                            <div class="popover__header">
                                <h4 class="popover__title">Add TaskList</h4>
                                <button class="btn-exit" popovertarget="add-tasklist-popover"
                                        popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <input type="text" class="form-input form-input--small add-tasklist-input"
                                       placeholder="Tên TaskList">
                            </div>
                            <div class="popover__footer">
                                <button class="btn btn--tertiary btn--small" popovertarget="add-tasklist-popover"
                                        popovertargetaction="hide">
                                    Cancel
                                </button>
                                <button class="btn btn--primary btn--small create-tasklist-btn">Create</button>
                            </div>
                        </div>

                        <!-- Popover cho Archive -->
                        <div id="archive-popover" popover class="popover sidebar-popover popover--danger">
                            <div class="popover__header">
                                <h4 class="popover__title">Archive Card?</h4>
                                <button class="btn-exit" popovertarget="archive-popover" popovertargetaction="hide">
                                    <i data-lucide="x"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <p>Archived cards can be restored from the project's archive page.</p>
                            </div>
                            <div class="popover__footer">
                                <button class="btn btn--tertiary" popovertarget="archive-popover"
                                        popovertargetaction="hide">
                                    Cancel
                                </button>
                                <button class="btn btn-delete">Archive</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-sidebar__section modal-sidebar__section--danger-zone">
                        <button class="sidebar-action-btn btn-delete" id="deleteProjectBtn"
                                popovertarget="confirmDeletePopover" type="button">
                            <i data-lucide="trash-2"></i>
                            <span class="sidebar-action__name">Delete project</span>
                        </button>

                        <div popover id="confirmDeletePopover" class="popover sidebar-popover popover--danger">
                            <div class="popover__header">
                                <h5 class="popover__title">Confirm Deletion</h5>
                                <!-- Nút đóng popover -->
                                <button class="btn-exit" popovertarget="confirmDeletePopover"
                                        popovertargetaction="hide">
                                    <i data-lucide="x" class="icon-sm"></i>
                                </button>
                            </div>
                            <div class="popover__body">
                                <p class="modal-description" style="font-size: var(--font-size-xs);">
                                    This action is permanent. To confirm, enter the project name
                                    <strong id="projectNameToDelete" style="color: var(--color-danger);">
                                        Dashboard
                                        UI Restructure
                                    </strong> below.
                                </p>
                                <input type="text" id="deleteConfirmationInput" class="form-input form-input--small"
                                       placeholder="Enter project name...">
                            </div>
                            <div class="popover__footer">
                                <button class="btn btn--secondary btn--small" id="cancelDeleteBtn"
                                        onclick="this.closest('.popover').hidePopover();">
                                    Cancel
                                </button>
                                <button class="btn btn-delete btn--small" id="confirmDeleteBtn" disabled>Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
